import{r as t,K as v,I as D,ar as E,j as x}from"./index-Dw0jMVas.js";import{u as I,R as V}from"./useRoles-DXPXp7bJ.js";import{Q as L}from"./questionnaire-CXWDgbJ4.js";const N=({entityId:c,entityModel:o})=>{const{fetchQuestionnaires:q,fetchQuestionnaire:g}=t.useContext(v.EscolaLMSContext),[m,S]=t.useState([]),[k,r]=t.useState(!1),[f,_]=t.useState(null),w=t.useCallback(async i=>{try{const a=await g(o,c,i);return a!=null&&a.success?a.data.questions:null}catch(a){return D(E("UnexpectedError"),"error"),console.error(a),null}},[c,o,g]),n=t.useCallback(async()=>{r(!0),_(null);try{const i=await q(o,c);if(i!=null&&i.success){const a=await Promise.all(i.data.map(async u=>{const h=await w(u.id),l=u.questions.reduce((Q,b)=>{const p=h==null?void 0:h.find(s=>s.id===b.id),e={...b,rate:p==null?void 0:p.rate,note:p==null?void 0:p.note};return e.rate===null&&e.note===null&&Q.push(e),Q},[]);return{...u,questions:l.sort((Q,b)=>Q.position-b.position)}}));S(a.filter(u=>u.questions.length>0))}}catch(i){_("Failed to fetch questionnaires"),D(E("UnexpectedError"),"error"),console.error(i)}finally{r(!1)}},[c,o,q,w]),y=t.useCallback(({questionnaireId:i,questionType:a})=>{var u,h;return(h=(u=m==null?void 0:m.find(l=>l.id===i))==null?void 0:u.questions.filter(l=>l.public_answers).find(l=>l.type===a))==null?void 0:h.id},[m]);return{questionnaires:m,loading:k,error:f,getQuestionnaires:n,getReviewQuestion:y}},z=({entityId:c,entityModel:o,onFinish:q,onSuccesGetQuestionnaires:g})=>{const{questionnaires:m,loading:S,getQuestionnaires:k}=N({entityId:c||0,entityModel:o}),[r,f]=t.useState({show:!1,step:0,loading:!0,firstVisit:!0,firstTimeQuestionnaires:[],reShowableQuestionnaires:[]}),{isStudent:_,isTutor:w}=I(),n=t.useMemo(()=>m.filter(e=>e.models.some(s=>s.model_type_title===o?s.model_type_title===L.CONSULTATION?_&&s.target_group==="user"||w&&s.target_group==="author":!0:!1)),[m,_,w,o]),y=t.useCallback(()=>{if(!n)return;const e=n.reduce((s,d)=>{var T;const C=(T=d.models.find(F=>F.model_type_title===o))==null?void 0:T.display_frequency_minutes;return C===0||!C?s.firstTimeQuestionnaires.push(d):s.reShowableQuestionnaires.push(d),s},{firstTimeQuestionnaires:[],reShowableQuestionnaires:[]});f(s=>({...s,...e}))},[n,o]),i=t.useCallback(e=>{var s;return(s=e.models.find(d=>d.model_type_title===o))==null?void 0:s.display_frequency_minutes},[o]),a=t.useCallback(e=>{i(e)&&localStorage.setItem(`questionnaire_${e.id}_last_display_time`,Date.now().toString())},[i]),u=t.useCallback(()=>{f(s=>({...s,step:s.step+1}));const e=setTimeout(()=>{f(s=>({...s,show:!0}))},500);return()=>clearTimeout(e)},[]),h=t.useCallback(()=>{a(n[r.step]),f(e=>({...e,show:!1})),r.step<n.length-1?r.firstVisit&&u():f(e=>({...e,show:!1,firstVisit:!1}))},[n,r.step,r.firstVisit,a,u]),l=t.useCallback(e=>(i(e)??0)*60*1e3,[i]),Q=t.useCallback(e=>{const s=localStorage.getItem(`questionnaire_${e.id}_last_display_time`);if(!s)return;const d=l(e),C=Date.now()-Number(s);return!s||C>=d},[l]),b=t.useCallback(e=>{f(s=>({...s,show:!0,step:n.findIndex(d=>d.id===e.id)}))},[n]),p=t.useCallback(()=>setInterval(()=>{r.reShowableQuestionnaires.forEach(e=>{Q(e)&&b(e)})},1e3),[Q,b,r]);return t.useEffect(()=>{k()},[c]),t.useEffect(()=>(n.length&&r.firstVisit&&f(e=>({...e,show:!0})),n.length&&g&&g(!0),y(),()=>{}),[n,g,r.firstVisit,y]),t.useEffect(()=>{const e=p();return()=>clearInterval(e)},[r.reShowableQuestionnaires,o,p]),x.jsx(x.Fragment,{children:r.show&&c&&!!n.length&&!S&&x.jsx(V,{entityModel:o,entityId:Number(c),visible:r.show,onClose:h,questionnaire:n[r.step],onFinish:q})})};export{z as Q};
