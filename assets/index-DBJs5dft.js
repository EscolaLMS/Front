import{D as N,z as F,af as L,c as R,n as V,j as D}from"./index-DHorRSia.js";import{r}from"./sentry-DZqhWugq.js";import{u as j,R as z}from"./useRoles-Dxl24k1Q.js";import{Q as U}from"./questionnaire-CXWDgbJ4.js";const K=({entityId:o,entityModel:n})=>{const{fetchQuestionnaires:_,fetchQuestionnaire:C}=r.useContext(N.EscolaLMSContext),[d,k]=r.useState([]),[q,g]=r.useState(!1),[t,u]=r.useState(null),S=r.useCallback(async a=>{try{const i=await C(n,o,a);return i!=null&&i.success?i.data.questions:null}catch(i){return F(L("UnexpectedError"),"error"),console.error(i),null}},[o,n,C]),T=r.useCallback(async()=>{g(!0),u(null);try{const a=await _(n,o);if(a!=null&&a.success){const i=await Promise.all(a.data.map(async l=>{const f=await S(l.id),m=l.questions.reduce((b,w)=>{const p=f==null?void 0:f.find(x=>x.id===w.id),y={...w,rate:p==null?void 0:p.rate,note:p==null?void 0:p.note};return b.push(y),b},[]);return{...l,questions:m.sort((b,w)=>b.position-w.position)}}));k(i.filter(l=>l.questions.length>0))}}catch(a){u("Failed to fetch questionnaires"),F(L("UnexpectedError"),"error"),console.error(a)}finally{g(!1)}},[o,n,_,S]),h=r.useCallback(({questionnaireId:a,questionType:i})=>{var l,f;return(f=(l=d==null?void 0:d.find(m=>m.id===a))==null?void 0:l.questions.filter(m=>m.public_answers).find(m=>m.type===i))==null?void 0:f.id},[d]);return{questionnaires:d,loading:q,error:t,getQuestionnaires:T,getReviewQuestion:h}},P=({entityId:o,entityModel:n,onSuccesGetQuestionnaires:_})=>{var x;const{questionnaires:C,loading:d,getQuestionnaires:k}=K({entityId:o||0,entityModel:n}),{settings:q}=r.useContext(R.EscolaLMSContext),g=(x=q==null?void 0:q.value)==null?void 0:x.config[V.questionnaireFirstTimeMetaKey],[t,u]=r.useState({show:!1,step:0,loading:!0,firstVisit:!0,firstTimeQuestionnaires:[],reShowableQuestionnaires:[]}),{isStudent:S,isTutor:T}=j(),h=r.useMemo(()=>C.filter(s=>s.models.some(e=>e.model_type_title===n?e.model_type_title===U.CONSULTATION?S&&e.target_group==="user"||T&&e.target_group==="author":!0:!1)),[C,S,T,n]),a=r.useCallback(()=>{if(!h)return;const s=h.reduce((e,c)=>{var E;const Q=(E=c.models.find(v=>v.model_type_title===n&&v.model_id===o))==null?void 0:E.display_frequency_minutes;return!Q&&Q!==void 0&&Q!==0&&e.firstTimeQuestionnaires.push(c),Q!=null&&Q!==0&&e.reShowableQuestionnaires.push(c),e},{firstTimeQuestionnaires:[],reShowableQuestionnaires:[]});u(e=>({...e,...s}))},[h,n,o]),i=r.useCallback(s=>{var e;return(e=s.models.find(c=>c.model_type_title===n&&c.model_id===o))==null?void 0:e.display_frequency_minutes},[n,o]),l=r.useCallback(s=>{i(s)&&localStorage.setItem(`questionnaire_${s.id}_last_display_time`,Date.now().toString())},[i]),f=r.useCallback(()=>{u(e=>({...e,step:e.step+1}));const s=setTimeout(()=>{u(e=>({...e,show:!0}))},500);return()=>clearTimeout(s)},[]),m=r.useCallback(()=>{l([...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires][t.step]),u(s=>({...s,show:!1})),t.step<[...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires].length-1?t.firstVisit&&f():u(s=>({...s,show:!1,firstVisit:!1}))},[t,l,f]),b=r.useCallback(s=>(i(s)??0)*60*1e3,[i]),w=r.useCallback(s=>{const e=localStorage.getItem(`questionnaire_${s.id}_last_display_time`);if(!e)return;const c=b(s),Q=Date.now()-Number(e);return!e||Q>=c},[b]),p=r.useCallback(s=>{u(e=>({...e,show:!0,step:[...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires].findIndex(c=>c.id===s.id)}))},[t]),y=r.useCallback(()=>setInterval(()=>{t.reShowableQuestionnaires.forEach(s=>{w(s)&&p(s)})},1e3),[w,p,t]);return r.useEffect(()=>{k()},[o]),r.useEffect(()=>{let s;return h.length&&t.firstVisit&&(g?s=setTimeout(()=>{u(e=>({...e,show:!0}))},g*60*1e3):u(e=>({...e,show:!0}))),h.length&&_&&_(!0),a(),()=>{clearTimeout(s)}},[g,h,_,t.firstVisit,a]),r.useEffect(()=>{const s=y();return()=>clearInterval(s)},[t.reShowableQuestionnaires,n,y]),D.jsx(D.Fragment,{children:t.show&&o&&!![...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires].length&&!d&&D.jsx(z,{entityModel:n,entityId:Number(o),visible:t.show,onClose:m,questionnaire:[...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires][t.step]})})};export{P as Q,K as u};
//# sourceMappingURL=index-DBJs5dft.js.map
