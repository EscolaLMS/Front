{"version":3,"file":"saveImageWorker-D-miS2i4.js","sources":["../src/workers/saveImageWorker.ts"],"sourcesContent":["export {};\n\nexport interface Screenshot {\n  dataURL: Blob;\n  timestamp: number;\n  userID: number;\n  consultationId: number | undefined;\n}\n\nexport interface SaveImagesMessage {\n  consultationId: number;\n  consultationTermId: number;\n  userEmail: string;\n  userId: number;\n  screenshots: Screenshot[];\n  term: string;\n  apiUrl?: string;\n}\n\nlet API_URL: string;\n\nconst retryFetch = async (\n  url: string,\n  options: RequestInit,\n  retries: number = 3,\n  delay: number = 2000\n): Promise<Response> => {\n  return new Promise((resolve, reject) => {\n    const attemptFetch = async (attempt: number) => {\n      try {\n        const response = await fetch(url, options);\n        if (!response.ok) {\n          throw new Error(`HTTP error! status: ${response.status}`);\n        }\n        resolve(response);\n      } catch (error) {\n        console.error(`Fetch attempt ${attempt + 1} failed:`, error);\n\n        if (attempt < retries - 1) {\n          setTimeout(() => attemptFetch(attempt + 1), delay);\n        } else {\n          reject(`Retries exhausted. Last error: ${error}`);\n        }\n      }\n    };\n\n    attemptFetch(0);\n  });\n};\n\nfunction getFormattedFilename(screenshot: Screenshot): string {\n  const date = new Date(screenshot.timestamp);\n  const pad = (n: number) => n.toString().padStart(2, \"0\");\n\n  const formattedTimestamp =\n    `${date.getFullYear()}${pad(date.getMonth() + 1)}${pad(date.getDate())}_` +\n    `${pad(date.getHours())}_${pad(date.getMinutes())}_${pad(\n      date.getSeconds()\n    )}`;\n\n  return `${screenshot.userID}_${screenshot.consultationId}_${formattedTimestamp}.webp`;\n}\n\nself.onmessage = async (event: MessageEvent<SaveImagesMessage>) => {\n  const {\n    consultationId,\n    consultationTermId,\n    userEmail,\n    userId,\n    screenshots,\n    term,\n  } = event.data;\n\n  if (event.data.apiUrl) {\n    API_URL = event.data.apiUrl; // Store the environment variable\n    return; // Exit early if it's just setting the API URL\n  }\n\n  try {\n    const filenames = screenshots.map((screenshot) => ({\n      filename: getFormattedFilename(screenshot),\n    }));\n\n    const signUrls = await retryFetch(\n      `${API_URL}/api/consultations/signed-screen-urls`,\n      {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({\n          consultation_id: consultationId,\n          user_termin_id: consultationTermId,\n          user_id: userId,\n          user_email: userEmail,\n          files: filenames,\n          executed_at: term,\n        }),\n      }\n    );\n\n    if (!signUrls.ok) {\n      throw new Error(`Failed to sign URLs: ${signUrls.statusText}`);\n    }\n\n    const responseData = await signUrls.json();\n\n    for (let i = 0; i < responseData.data.length; i++) {\n      const { url, filename } = responseData.data[i];\n      const screenshot = screenshots.find(\n        (s) => getFormattedFilename(s) === filename\n      );\n\n      if (!screenshot) {\n        console.warn(`Screenshot not found for filename: ${filename}`);\n        continue;\n      }\n\n      try {\n        const blob = new Blob([screenshot.dataURL]);\n        const response = await fetch(url, {\n          method: \"PUT\",\n          body: blob,\n        });\n\n        if (!response.ok) {\n          console.error(`Failed to upload ${filename}: ${response.statusText}`);\n        } else {\n          console.log(`File ${filename} uploaded successfully.`);\n        }\n      } catch (error) {\n        console.error(`Error uploading ${filename}:`, error);\n      }\n    }\n\n    self.postMessage({ success: true });\n  } catch (error) {\n    self.postMessage({\n      success: false,\n      error: error instanceof Error ? error.message : \"Unknown error\",\n    });\n  }\n};\n"],"names":["API_URL","retryFetch","url","options","retries","delay","resolve","reject","attemptFetch","attempt","response","error","getFormattedFilename","screenshot","date","pad","n","formattedTimestamp","event","consultationId","consultationTermId","userEmail","userId","screenshots","term","filenames","signUrls","responseData","filename","s","blob"],"mappings":"yBAmBA,IAAIA,EAEJ,MAAMC,EAAa,MACjBC,EACAC,EACAC,EAAkB,EAClBC,EAAgB,MAET,IAAI,QAAQ,CAACC,EAASC,IAAW,CAChC,MAAAC,EAAe,MAAOC,GAAoB,CAC1C,GAAA,CACF,MAAMC,EAAW,MAAM,MAAMR,EAAKC,CAAO,EACrC,GAAA,CAACO,EAAS,GACZ,MAAM,IAAI,MAAM,uBAAuBA,EAAS,MAAM,EAAE,EAE1DJ,EAAQI,CAAQ,QACTC,EAAO,CACd,QAAQ,MAAM,iBAAiBF,EAAU,CAAC,WAAYE,CAAK,EAEvDF,EAAUL,EAAU,EACtB,WAAW,IAAMI,EAAaC,EAAU,CAAC,EAAGJ,CAAK,EAE1CE,EAAA,kCAAkCI,CAAK,EAAE,CAClD,CAEJ,EAEAH,EAAa,CAAC,CAAA,CACf,EAGH,SAASI,EAAqBC,EAAgC,CAC5D,MAAMC,EAAO,IAAI,KAAKD,EAAW,SAAS,EACpCE,EAAOC,GAAcA,EAAE,WAAW,SAAS,EAAG,GAAG,EAEjDC,EACJ,GAAGH,EAAK,YAAa,CAAA,GAAGC,EAAID,EAAK,SAAS,EAAI,CAAC,CAAC,GAAGC,EAAID,EAAK,QAAS,CAAA,CAAC,IACnEC,EAAID,EAAK,SAAS,CAAC,CAAC,IAAIC,EAAID,EAAK,YAAY,CAAC,IAAIC,EACnDD,EAAK,WAAW,CAAA,CACjB,GAEH,MAAO,GAAGD,EAAW,MAAM,IAAIA,EAAW,cAAc,IAAII,CAAkB,OAChF,CAEA,KAAK,UAAY,MAAOC,GAA2C,CAC3D,KAAA,CACJ,eAAAC,EACA,mBAAAC,EACA,UAAAC,EACA,OAAAC,EACA,YAAAC,EACA,KAAAC,GACEN,EAAM,KAEN,GAAAA,EAAM,KAAK,OAAQ,CACrBlB,EAAUkB,EAAM,KAAK,OACrB,MAAA,CAGE,GAAA,CACF,MAAMO,EAAYF,EAAY,IAAKV,IAAgB,CACjD,SAAUD,EAAqBC,CAAU,CAAA,EACzC,EAEIa,EAAW,MAAMzB,EACrB,GAAGD,CAAO,wCACV,CACE,OAAQ,OACR,QAAS,CACP,eAAgB,kBAClB,EACA,KAAM,KAAK,UAAU,CACnB,gBAAiBmB,EACjB,eAAgBC,EAChB,QAASE,EACT,WAAYD,EACZ,MAAOI,EACP,YAAaD,CACd,CAAA,CAAA,CAEL,EAEI,GAAA,CAACE,EAAS,GACZ,MAAM,IAAI,MAAM,wBAAwBA,EAAS,UAAU,EAAE,EAGzD,MAAAC,EAAe,MAAMD,EAAS,KAAK,EAEzC,QAAS,EAAI,EAAG,EAAIC,EAAa,KAAK,OAAQ,IAAK,CACjD,KAAM,CAAE,IAAAzB,EAAK,SAAA0B,CAAA,EAAaD,EAAa,KAAK,CAAC,EACvCd,EAAaU,EAAY,KAC5BM,GAAMjB,EAAqBiB,CAAC,IAAMD,CACrC,EAEA,GAAI,CAACf,EAAY,CACP,QAAA,KAAK,sCAAsCe,CAAQ,EAAE,EAC7D,QAAA,CAGE,GAAA,CACF,MAAME,EAAO,IAAI,KAAK,CAACjB,EAAW,OAAO,CAAC,EACpCH,EAAW,MAAM,MAAMR,EAAK,CAChC,OAAQ,MACR,KAAM4B,CAAA,CACP,EAEIpB,EAAS,GAGJ,QAAA,IAAI,QAAQkB,CAAQ,yBAAyB,EAFrD,QAAQ,MAAM,oBAAoBA,CAAQ,KAAKlB,EAAS,UAAU,EAAE,QAI/DC,EAAO,CACd,QAAQ,MAAM,mBAAmBiB,CAAQ,IAAKjB,CAAK,CAAA,CACrD,CAGF,KAAK,YAAY,CAAE,QAAS,EAAA,CAAM,QAC3BA,EAAO,CACd,KAAK,YAAY,CACf,QAAS,GACT,MAAOA,aAAiB,MAAQA,EAAM,QAAU,eAAA,CACjD,CAAA,CAEL"}