import{r,N,J as F,as as L,i as R,x as V,j as E}from"./index-Ccx-J0-t.js";import{u as j,R as U}from"./useRoles-Dcieg_3K.js";import{Q as z}from"./questionnaire-CXWDgbJ4.js";const K=({entityId:o,entityModel:n})=>{const{fetchQuestionnaires:_,fetchQuestionnaire:q}=r.useContext(N.EscolaLMSContext),[d,k]=r.useState([]),[S,g]=r.useState(!1),[t,u]=r.useState(null),T=r.useCallback(async a=>{try{const i=await q(n,o,a);return i!=null&&i.success?i.data.questions:null}catch(i){return F(L("UnexpectedError"),"error"),console.error(i),null}},[o,n,q]),x=r.useCallback(async()=>{g(!0),u(null);try{const a=await _(n,o);if(a!=null&&a.success){const i=await Promise.all(a.data.map(async l=>{const f=await T(l.id),p=l.questions.reduce((b,w)=>{const m=f==null?void 0:f.find(y=>y.id===w.id),C={...w,rate:m==null?void 0:m.rate,note:m==null?void 0:m.note};return C.rate===null&&C.note===null&&b.push(C),b},[]);return{...l,questions:p.sort((b,w)=>b.position-w.position)}}));k(i.filter(l=>l.questions.length>0))}}catch(a){u("Failed to fetch questionnaires"),F(L("UnexpectedError"),"error"),console.error(a)}finally{g(!1)}},[o,n,_,T]),h=r.useCallback(({questionnaireId:a,questionType:i})=>{var l,f;return(f=(l=d==null?void 0:d.find(p=>p.id===a))==null?void 0:l.questions.filter(p=>p.public_answers).find(p=>p.type===i))==null?void 0:f.id},[d]);return{questionnaires:d,loading:S,error:t,getQuestionnaires:x,getReviewQuestion:h}},I=({entityId:o,entityModel:n,onSuccesGetQuestionnaires:_})=>{var y;const{questionnaires:q,loading:d,getQuestionnaires:k}=K({entityId:o||0,entityModel:n}),{settings:S}=r.useContext(R.EscolaLMSContext),g=(y=S==null?void 0:S.value)==null?void 0:y.config[V.questionnaireFirstTimeMetaKey],[t,u]=r.useState({show:!1,step:0,loading:!0,firstVisit:!0,firstTimeQuestionnaires:[],reShowableQuestionnaires:[]}),{isStudent:T,isTutor:x}=j(),h=r.useMemo(()=>q.filter(s=>s.models.some(e=>e.model_type_title===n?e.model_type_title===z.CONSULTATION?T&&e.target_group==="user"||x&&e.target_group==="author":!0:!1)),[q,T,x,n]),a=r.useCallback(()=>{if(!h)return;const s=h.reduce((e,c)=>{var v;const Q=(v=c.models.find(D=>D.model_type_title===n&&D.model_id===o))==null?void 0:v.display_frequency_minutes;return!Q&&Q!==void 0&&Q!==0&&e.firstTimeQuestionnaires.push(c),Q!=null&&Q!==0&&e.reShowableQuestionnaires.push(c),e},{firstTimeQuestionnaires:[],reShowableQuestionnaires:[]});u(e=>({...e,...s}))},[h,n,o]),i=r.useCallback(s=>{var e;return(e=s.models.find(c=>c.model_type_title===n&&c.model_id===o))==null?void 0:e.display_frequency_minutes},[n,o]),l=r.useCallback(s=>{i(s)&&localStorage.setItem(`questionnaire_${s.id}_last_display_time`,Date.now().toString())},[i]),f=r.useCallback(()=>{u(e=>({...e,step:e.step+1}));const s=setTimeout(()=>{u(e=>({...e,show:!0}))},500);return()=>clearTimeout(s)},[]),p=r.useCallback(()=>{l([...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires][t.step]),u(s=>({...s,show:!1})),t.step<[...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires].length-1?t.firstVisit&&f():u(s=>({...s,show:!1,firstVisit:!1}))},[t,l,f]),b=r.useCallback(s=>(i(s)??0)*60*1e3,[i]),w=r.useCallback(s=>{const e=localStorage.getItem(`questionnaire_${s.id}_last_display_time`);if(!e)return;const c=b(s),Q=Date.now()-Number(e);return!e||Q>=c},[b]),m=r.useCallback(s=>{u(e=>({...e,show:!0,step:[...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires].findIndex(c=>c.id===s.id)}))},[t]),C=r.useCallback(()=>setInterval(()=>{t.reShowableQuestionnaires.forEach(s=>{w(s)&&m(s)})},1e3),[w,m,t]);return r.useEffect(()=>{k()},[o]),r.useEffect(()=>{let s;return h.length&&t.firstVisit&&(g?s=setTimeout(()=>{u(e=>({...e,show:!0}))},g*60*1e3):u(e=>({...e,show:!0}))),h.length&&_&&_(!0),a(),()=>{clearTimeout(s)}},[g,h,_,t.firstVisit,a]),r.useEffect(()=>{const s=C();return()=>clearInterval(s)},[t.reShowableQuestionnaires,n,C]),E.jsx(E.Fragment,{children:t.show&&o&&!![...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires].length&&!d&&E.jsx(U,{entityModel:n,entityId:Number(o),visible:t.show,onClose:p,questionnaire:[...t.firstTimeQuestionnaires,...t.reShowableQuestionnaires][t.step]})})};export{I as Q,K as u};
