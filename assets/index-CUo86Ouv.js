import{r as t,K as v,I as D,as as E,j as x}from"./index-fLzfRICx.js";import{u as V,R as I}from"./useRoles-0ozfsvuk.js";const R=({entityId:c,entityModel:o})=>{const{fetchQuestionnaires:q,fetchQuestionnaire:Q}=t.useContext(v.EscolaLMSContext),[h,S]=t.useState([]),[k,r]=t.useState(!1),[f,w]=t.useState(null),_=t.useCallback(async i=>{try{const a=await Q(o,c,i);return a!=null&&a.success?a.data.questions:null}catch(a){return D(E("UnexpectedError"),"error"),console.error(a),null}},[c,o,Q]),n=t.useCallback(async()=>{r(!0),w(null);try{const i=await q(o,c);if(i!=null&&i.success){const a=await Promise.all(i.data.map(async u=>{const m=await _(u.id),l=u.questions.reduce((b,g)=>{const p=m==null?void 0:m.find(s=>s.id===g.id),e={...g,rate:p==null?void 0:p.rate,note:p==null?void 0:p.note};return e.rate===null&&e.note===null&&b.push(e),b},[]);return{...u,questions:l.sort((b,g)=>b.position-g.position)}}));S(a.filter(u=>u.questions.length>0))}}catch(i){w("Failed to fetch questionnaires"),D(E("UnexpectedError"),"error"),console.error(i)}finally{r(!1)}},[c,o,q,_]),C=t.useCallback(({questionnaireId:i,questionType:a})=>{var u,m;return(m=(u=h==null?void 0:h.find(l=>l.id===i))==null?void 0:u.questions.filter(l=>l.public_answers).find(l=>l.type===a))==null?void 0:m.id},[h]);return{questionnaires:h,loading:k,error:f,getQuestionnaires:n,getReviewQuestion:C}},N=({entityId:c,entityModel:o,onFinish:q,onSuccesGetQuestionnaires:Q})=>{const{questionnaires:h,loading:S,getQuestionnaires:k}=R({entityId:c||0,entityModel:o}),[r,f]=t.useState({show:!1,step:0,loading:!0,firstVisit:!0,firstTimeQuestionnaires:[],reShowableQuestionnaires:[]}),{isStudent:w,isTutor:_}=V(),n=t.useMemo(()=>h.filter(e=>e.models.some(s=>s.model_type_title===o&&(w&&s.target_group==="user"||_&&s.target_group==="author"))),[h,w,_,o]),C=t.useCallback(()=>{if(!n)return;const e=n.reduce((s,d)=>{var T;const y=(T=d.models.find(F=>F.model_type_title===o))==null?void 0:T.display_frequency_minutes;return y===0||!y?s.firstTimeQuestionnaires.push(d):s.reShowableQuestionnaires.push(d),s},{firstTimeQuestionnaires:[],reShowableQuestionnaires:[]});f(s=>({...s,...e}))},[n,o]),i=t.useCallback(e=>{var s;return(s=e.models.find(d=>d.model_type_title===o))==null?void 0:s.display_frequency_minutes},[o]),a=t.useCallback(e=>{i(e)&&localStorage.setItem(`questionnaire_${e.id}_last_display_time`,Date.now().toString())},[i]),u=t.useCallback(()=>{f(s=>({...s,step:s.step+1}));const e=setTimeout(()=>{f(s=>({...s,show:!0}))},500);return()=>clearTimeout(e)},[]),m=t.useCallback(()=>{a(n[r.step]),f(e=>({...e,show:!1})),r.step<n.length-1?r.firstVisit&&u():f(e=>({...e,show:!1,firstVisit:!1}))},[n,r.step,r.firstVisit,a,u]),l=t.useCallback(e=>(i(e)??0)*60*1e3,[i]),b=t.useCallback(e=>{const s=localStorage.getItem(`questionnaire_${e.id}_last_display_time`);if(!s)return;const d=l(e),y=Date.now()-Number(s);return!s||y>=d},[l]),g=t.useCallback(e=>{f(s=>({...s,show:!0,step:n.findIndex(d=>d.id===e.id)}))},[n]),p=t.useCallback(()=>setInterval(()=>{r.reShowableQuestionnaires.forEach(e=>{b(e)&&g(e)})},1e3),[b,g,r]);return t.useEffect(()=>{k()},[c]),t.useEffect(()=>(n.length&&r.firstVisit&&f(e=>({...e,show:!0})),n.length&&Q&&Q(!0),C(),()=>{}),[n,Q,r.firstVisit,C]),t.useEffect(()=>{const e=p();return()=>clearInterval(e)},[r.reShowableQuestionnaires,o,p]),x.jsx(x.Fragment,{children:r.show&&c&&!!n.length&&!S&&x.jsx(I,{entityModel:o,entityId:Number(c),visible:r.show,onClose:m,questionnaire:n[r.step],onFinish:q})})};export{N as Q};
