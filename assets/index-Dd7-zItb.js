import{r as t,N,J as D,as as v,i as V,x as I,j as k}from"./index-Cov4NIbj.js";import{u as R,R as j}from"./useRoles-v00MWHfW.js";import{Q as U}from"./questionnaire-CXWDgbJ4.js";const z=({entityId:c,entityModel:o})=>{const{fetchQuestionnaires:g,fetchQuestionnaire:w}=t.useContext(N.EscolaLMSContext),[h,S]=t.useState([]),[y,q]=t.useState(!1),[r,u]=t.useState(null),C=t.useCallback(async a=>{try{const i=await w(o,c,a);return i!=null&&i.success?i.data.questions:null}catch(i){return D(v("UnexpectedError"),"error"),console.error(i),null}},[c,o,w]),x=t.useCallback(async()=>{q(!0),u(null);try{const a=await g(o,c);if(a!=null&&a.success){const i=await Promise.all(a.data.map(async l=>{const f=await C(l.id),p=l.questions.reduce((Q,b)=>{const m=f==null?void 0:f.find(T=>T.id===b.id),_={...b,rate:m==null?void 0:m.rate,note:m==null?void 0:m.note};return _.rate===null&&_.note===null&&Q.push(_),Q},[]);return{...l,questions:p.sort((Q,b)=>Q.position-b.position)}}));S(i.filter(l=>l.questions.length>0))}}catch(a){u("Failed to fetch questionnaires"),D(v("UnexpectedError"),"error"),console.error(a)}finally{q(!1)}},[c,o,g,C]),n=t.useCallback(({questionnaireId:a,questionType:i})=>{var l,f;return(f=(l=h==null?void 0:h.find(p=>p.id===a))==null?void 0:l.questions.filter(p=>p.public_answers).find(p=>p.type===i))==null?void 0:f.id},[h]);return{questionnaires:h,loading:y,error:r,getQuestionnaires:x,getReviewQuestion:n}},A=({entityId:c,entityModel:o,onSuccesGetQuestionnaires:g})=>{var T;const{questionnaires:w,loading:h,getQuestionnaires:S}=z({entityId:c||0,entityModel:o}),{settings:y}=t.useContext(V.EscolaLMSContext),q=(T=y==null?void 0:y.value)==null?void 0:T.config[I.questionnaireFirstTimeMetaKey],[r,u]=t.useState({show:!1,step:0,loading:!0,firstVisit:!0,firstTimeQuestionnaires:[],reShowableQuestionnaires:[],endTimeQuestionnaires:[]}),{isStudent:C,isTutor:x}=R(),n=t.useMemo(()=>w.filter(s=>s.models.some(e=>e.model_type_title===o?e.model_type_title===U.CONSULTATION?C&&e.target_group==="user"||x&&e.target_group==="author":!0:!1)),[w,C,x,o]),a=t.useCallback(()=>{if(!n)return;const s=n.reduce((e,d)=>{var E;return((E=d.models.find(L=>L.model_type_title===o))==null?void 0:E.display_frequency_minutes)===0?e.firstTimeQuestionnaires.push(d):e.reShowableQuestionnaires.push(d),e},{firstTimeQuestionnaires:[],reShowableQuestionnaires:[]});u(e=>({...e,...s}))},[n,o]),i=t.useCallback(s=>{var e;return(e=s.models.find(d=>d.model_type_title===o))==null?void 0:e.display_frequency_minutes},[o]),l=t.useCallback(s=>{i(s)&&localStorage.setItem(`questionnaire_${s.id}_last_display_time`,Date.now().toString())},[i]),f=t.useCallback(()=>{u(e=>({...e,step:e.step+1}));const s=setTimeout(()=>{u(e=>({...e,show:!0}))},500);return()=>clearTimeout(s)},[]),p=t.useCallback(()=>{l(n[r.step]),u(s=>({...s,show:!1})),r.step<n.length-1?r.firstVisit&&f():u(s=>({...s,show:!1,firstVisit:!1}))},[n,r.step,r.firstVisit,l,f]),Q=t.useCallback(s=>(i(s)??0)*60*1e3,[i]),b=t.useCallback(s=>{const e=localStorage.getItem(`questionnaire_${s.id}_last_display_time`);if(!e)return;const d=Q(s),F=Date.now()-Number(e);return!e||F>=d},[Q]),m=t.useCallback(s=>{u(e=>({...e,show:!0,step:n.findIndex(d=>d.id===s.id)}))},[n]),_=t.useCallback(()=>setInterval(()=>{r.reShowableQuestionnaires.forEach(s=>{b(s)&&m(s)})},1e3),[b,m,r]);return t.useEffect(()=>{S()},[c]),t.useEffect(()=>{let s;return n.length&&r.firstVisit&&(q?s=setTimeout(()=>{u(e=>({...e,show:!0}))},q*60*1e3):u(e=>({...e,show:!0}))),n.length&&g&&g(!0),a(),()=>{clearTimeout(s)}},[q,n,g,r.firstVisit,a]),t.useEffect(()=>{const s=_();return()=>clearInterval(s)},[r.reShowableQuestionnaires,o,_]),k.jsx(k.Fragment,{children:r.show&&c&&!!n.length&&!h&&k.jsx(j,{entityModel:o,entityId:Number(c),visible:r.show,onClose:p,questionnaire:n[r.step]})})};export{A as Q};
