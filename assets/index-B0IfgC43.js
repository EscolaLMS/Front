import{r,J as T,N as O,h as U,aq as Q,ar as A,q as W,i as D,as as K,at as X,j as e,b as I,y as B,au as Y,a0 as Z,f as V,Q as E,M as k,m as z,C as ss,L as es,o as ts,v as q}from"./index-flVLDudU.js";import{P as H}from"./index-C99Szp3t.js";import{C as ns,a as rs}from"./CourseAgenda-Bnncf_A2.js";import{A as L}from"./index-xFIqmCTJ.js";import"./Upload-Bocujn81.js";function G(s,t="/course/"){var b,M;const{sendProgress:n,getNextPrevTopic:o,progress:d,courseProgressDetails:l,fetchProgress:w}=r.useContext(T.EscolaLMSContext),[y,v]=r.useState(!1),{lessonID:m,topicID:j}=O(),{push:x}=U(),h=r.useMemo(()=>Q((s==null?void 0:s.lessons)??[]),[s==null?void 0:s.lessons]),f=r.useMemo(()=>A((s==null?void 0:s.lessons)??[]),[s==null?void 0:s.lessons]),C=m?Number(m):(b=h==null?void 0:h[0])==null?void 0:b.id,c=j?Number(j):(M=f==null?void 0:f[0])==null?void 0:M.id;r.useEffect(()=>{c&&w()},[w,c]);const _=r.useMemo(()=>h.find(a=>a.id===C),[h,C]),u=r.useMemo(()=>f.find(a=>a.id===c),[f,c]),P=r.useMemo(()=>{var a;return((a=f.at(-1))==null?void 0:a.id)===(u==null?void 0:u.id)},[f,u==null?void 0:u.id]),$=r.useCallback(()=>{s.id&&n(s.id,[{topic_id:Number(c),status:1}]).then(()=>{const a=o(Number(c));a&&x(`${t}${s.id}/${a.lesson_id}/${a.id}`,null)})},[c,s,x,o,n,t]),i=r.useCallback(()=>{const a=o(Number(c),!1);if(s.id&&(u!=null&&u.can_skip)){n(s.id,[{topic_id:Number(c),status:1}]).then(()=>{a&&x(`${t}${s.id}/${a.lesson_id}/${a.id}`,null)});return}a&&x(`${t}${s.id}/${a.lesson_id}/${a.id}`,null)},[c,s,x,o,n,t,u]),p=r.useCallback((a=!0)=>{const g=o(Number(c),a);g&&x(`${t}${s.id}/${g==null?void 0:g.lesson_id}/${g==null?void 0:g.id}`)},[C,c,s,s.id,x,t]);return{topic:u,lesson:_,onNextTopic:$,onPrevTopic:i,getNextPrevTopic:o,isNextTopicButtonDisabled:y,disableNextTopicButton:v,onNextTopicPreview:p,sendProgress:n,progress:d,courseProgressDetails:l,isLastTopic:P}}const is=W.aside`
  padding-bottom: 100px;
  .show-agenda-btn {
    width: 100%;
  }
  .agenda-wrapper {
    ${D&&K`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      transform: translate(100%, 0);
      transition: transform 0.25s;
      overflow: scroll;
      padding: 40px 0 55px;
      z-index: 10;
      background-color: ${({theme:s})=>s.mode==="dark"?s.dm__background:s.background};
      &--visible {
        transform: translate(0, 0);
      }
      .hide-agenda-btn {
        display: block;
        margin: 0 15px 0 auto;
      }
    `}
  }
`,as=({course:s,topicId:t,onCompleteTopic:n,onCourseFinish:o})=>{var $;const{progress:d}=G(s),{courseProgressDetails:l,user:w,program:y}=r.useContext(T.EscolaLMSContext),v=r.useMemo(()=>y.value,[y.value]),m=r.useMemo(()=>(d.value??[]).find(({course:{id:i}})=>i===Number(s.id)),[d,s.id]),j=U(),[x,h]=r.useState(!1),f=((s==null?void 0:s.lessons)||[]).filter(i=>{var p;return(((p=i==null?void 0:i.topics)==null?void 0:p.length)??0)>0}),{topicIsFinished:C}=r.useContext(T.EscolaLMSContext),c=r.useMemo(()=>A(s.lessons??[]),[s.lessons]),_=r.useMemo(()=>{var p;const i=s.id;return l&&l.byId&&l.byId[Number(i)]&&l.byId[Number(i)].value?l.byId[Number(i)].value:d&&d.value&&((p=d.value.find(b=>b.course.id===Number(i)))==null?void 0:p.progress)},[d,s]),u=c.filter(i=>C(i.id)||(_==null?void 0:_.some(p=>p.topic_id===i.id&&p.status===1))).map(i=>i.id),P=r.useMemo(()=>{const i=((v==null?void 0:v.lessons)??[]).filter(N=>N.active_from===null||N.active_from&&X(new Date,new Date(N.active_from))),p=A(i),{incomplete:b,in_progress:M,complete:a}=p.reduce((N,F)=>{const S=((m==null?void 0:m.progress)??[]).find(({topic_id:J})=>J===F.id);if(!S)return N;const R={[L.CourseProgressItemElementStatus.INCOMPLETE]:"incomplete",[L.CourseProgressItemElementStatus.COMPLETE]:"complete",[L.CourseProgressItemElementStatus.IN_PROGRESS]:"in_progress"};return{...N,[R[S.status]]:[...N[R[S.status]],F.id]}},{in_progress:[],incomplete:[],complete:[]});if(M.length)return[...M,...a];const g=b!=null&&b[0]?[b[0]]:[];return[...a,...g]},[v==null?void 0:v.lessons,m==null?void 0:m.progress]);return!s&&!f?e.jsx(I.Fragment,{}):e.jsxs(is,{children:[D&&e.jsx(B.Button,{mode:"outline",className:"show-agenda-btn",onClick:()=>h(!0),children:Y("CourseProgram.ShowAgenda").toString()}),e.jsxs("div",{className:`${x?"agenda-wrapper agenda-wrapper--visible":"agenda-wrapper"}`,children:[D&&e.jsx(B.Button,{className:"hide-agenda-btn",mode:"secondary",onClick:()=>h(!1),children:"âœ•"}),e.jsx(ns.CourseAgenda,{areAllTopicsUnlocked:Z(Number(($=w.value)==null?void 0:$.id),s),lessons:s.lessons,currentTopicId:t,finishedTopicIds:u,onMarkFinished:()=>n==null?void 0:n(),onTopicClick:i=>{j.push(`/course/${s.id}/${i.lesson_id}/${i.id}`),h(!1)},onCourseFinished:()=>o==null?void 0:o(),availableTopicsIds:P})]})]})},os=({program:s})=>{var l;const{topic:t,lesson:n,onNextTopicPreview:o}=G(s,"/courses/preview/"),{t:d}=V();return r.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"})},[t==null?void 0:t.id,n==null?void 0:n.id]),e.jsx(I.Fragment,{children:e.jsx("div",{className:"course-program course-program-page",children:e.jsx("div",{className:"course-program-container",children:e.jsxs("div",{className:"course-program-wrapper course-program-wrapper-preview",children:[e.jsxs("div",{className:"course-program-player",children:[e.jsxs("div",{className:"course-program-player-content",children:[e.jsx("h2",{children:t==null?void 0:t.title}),t&&t.introduction&&e.jsx(E.Col,{sm:12,md:12,lg:12,children:e.jsx("div",{className:"container-md",children:e.jsx(k.MarkdownRenderer,{children:t.introduction})})}),e.jsx("div",{className:"course-program-player-content__wrapper",style:{...((l=t==null?void 0:t.json)==null?void 0:l.wrapperStyle)||{}},children:e.jsx(rs,{preview:!0,topic:t})})]}),e.jsxs(E.Row,{children:[n&&n.summary&&e.jsx(E.Col,{sm:12,md:12,lg:12,children:e.jsx("div",{className:"course-program-summary",children:e.jsx(k.MarkdownRenderer,{children:n.summary})})}),t&&t.summary&&e.jsx(E.Col,{sm:12,md:12,lg:12,children:e.jsx("div",{className:"course-program-summary",children:e.jsx(k.MarkdownRenderer,{children:t.summary})})})]}),e.jsx("div",{className:"course-program-player-next",children:e.jsxs("button",{className:"default-btn default-btn-equal",onClick:()=>o(),children:[e.jsxs("div",{className:"course-program-player-next-button__wrapper",children:[d("Next Topic")," >"]}),e.jsx("span",{})]})})]}),e.jsx(as,{course:s,topicId:Number(t==null?void 0:t.id)})]})})})})},ds=({program:s})=>{var v,m;const t=(m=(v=s==null?void 0:s.scorm)==null?void 0:v.scos)==null?void 0:m.find(j=>j.entry_url!==void 0),n=t==null?void 0:t.uuid,o=r.useRef(null),[d,l]=r.useState(0),w=610,{apiUrl:y}=r.useContext(z.EscolaLMSContext);return r.useEffect(()=>{var j,x,h,f;o.current&&l(((f=(h=(x=(j=o.current)==null?void 0:j.contentWindow)==null?void 0:x.document)==null?void 0:h.body)==null?void 0:f.scrollHeight)||0)},[o]),!t&&!n?e.jsx(I.Fragment,{}):e.jsx(I.Fragment,{children:e.jsx("div",{className:"container-fluid course-program",children:e.jsx("div",{className:"course-program-player scorm",style:{height:`${w+d}px`},children:e.jsx("iframe",{title:"scorm-player",ref:o,src:`${y}/api/scorm/play/${n}`,scrolling:"no"})})})})},hs=()=>{var d,l;const{t:s}=V(),{id:t}=O(),{program:n,fetchProgram:o}=r.useContext(z.EscolaLMSContext);return r.useEffect(()=>{t&&o(Number(t))},[t,o]),n.loading?e.jsx(H,{}):n.error?e.jsx(ss,{children:e.jsxs("div",{className:"alert alert-danger",role:"alert",children:[e.jsx("h4",{className:"alert-heading",children:s("Error")}),e.jsxs("p",{children:[" ",n.error.message||n.error.error]}),e.jsx("hr",{}),e.jsxs("p",{className:"mb-0",children:[s("CoursePage.Preview.SeeOther"),e.jsx(es,{to:ts.courses,children:s("Courses")}),"."]})]})}):n.value&&((l=(d=n==null?void 0:n.value)==null?void 0:d.scorm)!=null&&l.id)?e.jsx(q,{children:e.jsx(ds,{program:n.value})}):n.value&&n.value.lessons&&n.value.lessons.length?e.jsxs(q,{children:[e.jsx(os,{program:n.value}),";"]}):e.jsx(H,{})};export{hs as default};
