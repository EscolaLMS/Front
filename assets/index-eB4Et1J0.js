import{r,D as T,H as q,i as U,al as J,am as A,q as K,n as D,an as Q,ao as X,j as e,b as I,v as B,ap as Y,a0 as Z,f as V,w as E,M as k,h as z,C as ss,L as es,l as ns,o as H}from"./index-BrnsqxCr.js";import{P as O}from"./index-CsT2ZWt5.js";import{C as ts,a as rs}from"./CourseAgenda-BOwX9nob.js";import{A as L}from"./index-BJJpkyDu.js";import"./Upload-BDGyAjvP.js";import"./warning-C8QKL9Xh.js";import"./ResponsiveImage-Cy_iuZ6S.js";function G(s,n="/course/"){var b,M;const{sendProgress:t,getNextPrevTopic:o,progress:l,courseProgressDetails:d,fetchProgress:w}=r.useContext(T.EscolaLMSContext),[y,v]=r.useState(!1),{lessonID:m,topicID:j}=q(),{push:x}=U(),h=r.useMemo(()=>J((s==null?void 0:s.lessons)??[]),[s==null?void 0:s.lessons]),f=r.useMemo(()=>A((s==null?void 0:s.lessons)??[]),[s==null?void 0:s.lessons]),C=m?Number(m):(b=h==null?void 0:h[0])==null?void 0:b.id,c=j?Number(j):(M=f==null?void 0:f[0])==null?void 0:M.id;r.useEffect(()=>{c&&w()},[w,c]);const _=r.useMemo(()=>h.find(a=>a.id===C),[h,C]),u=r.useMemo(()=>f.find(a=>a.id===c),[f,c]),P=r.useMemo(()=>{var a;return((a=f.at(-1))==null?void 0:a.id)===(u==null?void 0:u.id)},[f,u==null?void 0:u.id]),$=r.useCallback(()=>{s.id&&t(s.id,[{topic_id:Number(c),status:1}]).then(()=>{const a=o(Number(c));a&&x(`${n}${s.id}/${a.lesson_id}/${a.id}`,null)})},[c,s,x,o,t,n]),i=r.useCallback(()=>{const a=o(Number(c),!1);if(s.id&&(u!=null&&u.can_skip)){t(s.id,[{topic_id:Number(c),status:1}]).then(()=>{a&&x(`${n}${s.id}/${a.lesson_id}/${a.id}`,null)});return}a&&x(`${n}${s.id}/${a.lesson_id}/${a.id}`,null)},[c,s,x,o,t,n,u]),p=r.useCallback((a=!0)=>{const g=o(Number(c),a);g&&x(`${n}${s.id}/${g==null?void 0:g.lesson_id}/${g==null?void 0:g.id}`)},[C,c,s,s.id,x,n]);return{topic:u,lesson:_,onNextTopic:$,onPrevTopic:i,getNextPrevTopic:o,isNextTopicButtonDisabled:y,disableNextTopicButton:v,onNextTopicPreview:p,sendProgress:t,progress:l,courseProgressDetails:d,isLastTopic:P}}const is=K.aside`
  padding-bottom: 100px;
  .show-agenda-btn {
    width: 100%;
  }
  .agenda-wrapper {
    ${D&&Q`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      transform: translate(100%, 0);
      transition: transform 0.25s;
      overflow: scroll;
      padding: 40px 0 55px;
      z-index: 10;
      background-color: ${({theme:s})=>s.mode==="dark"?s.dm__background:s.background};
      &--visible {
        transform: translate(0, 0);
      }
      .hide-agenda-btn {
        display: block;
        margin: 0 15px 0 auto;
      }
    `}
  }
`,as=({course:s,topicId:n,onCompleteTopic:t,onCourseFinish:o})=>{var $;const{progress:l}=G(s),{courseProgressDetails:d,user:w,program:y}=r.useContext(T.EscolaLMSContext),v=r.useMemo(()=>y.value,[y.value]),m=r.useMemo(()=>(l.value??[]).find(({course:{id:i}})=>i===Number(s.id)),[l,s.id]),j=U(),[x,h]=r.useState(!1),f=((s==null?void 0:s.lessons)||[]).filter(i=>{var p;return(((p=i==null?void 0:i.topics)==null?void 0:p.length)??0)>0}),{topicIsFinished:C}=r.useContext(T.EscolaLMSContext),c=r.useMemo(()=>A(s.lessons??[]),[s.lessons]),_=r.useMemo(()=>{var p;const i=s.id;return d&&d.byId&&d.byId[Number(i)]&&d.byId[Number(i)].value?d.byId[Number(i)].value:l&&l.value&&((p=l.value.find(b=>b.course.id===Number(i)))==null?void 0:p.progress)},[l,s]),u=c.filter(i=>C(i.id)||(_==null?void 0:_.some(p=>p.topic_id===i.id&&p.status===1))).map(i=>i.id),P=r.useMemo(()=>{const i=((v==null?void 0:v.lessons)??[]).filter(N=>N.active_from===null||N.active_from&&X(new Date,new Date(N.active_from))),p=A(i),{incomplete:b,in_progress:M,complete:a}=p.reduce((N,F)=>{const S=((m==null?void 0:m.progress)??[]).find(({topic_id:W})=>W===F.id);if(!S)return N;const R={[L.CourseProgressItemElementStatus.INCOMPLETE]:"incomplete",[L.CourseProgressItemElementStatus.COMPLETE]:"complete",[L.CourseProgressItemElementStatus.IN_PROGRESS]:"in_progress"};return{...N,[R[S.status]]:[...N[R[S.status]],F.id]}},{in_progress:[],incomplete:[],complete:[]});if(M.length)return[...M,...a];const g=b!=null&&b[0]?[b[0]]:[];return[...a,...g]},[v==null?void 0:v.lessons,m==null?void 0:m.progress]);return!s&&!f?e.jsx(I.Fragment,{}):e.jsxs(is,{children:[D&&e.jsx(B.Button,{mode:"outline",className:"show-agenda-btn",onClick:()=>h(!0),children:Y("CourseProgram.ShowAgenda").toString()}),e.jsxs("div",{className:`${x?"agenda-wrapper agenda-wrapper--visible":"agenda-wrapper"}`,children:[D&&e.jsx(B.Button,{className:"hide-agenda-btn",mode:"secondary",onClick:()=>h(!1),children:"âœ•"}),e.jsx(ts.CourseAgenda,{areAllTopicsUnlocked:Z(Number(($=w.value)==null?void 0:$.id),s),lessons:s.lessons,currentTopicId:n,finishedTopicIds:u,onMarkFinished:()=>t==null?void 0:t(),onTopicClick:i=>{j.push(`/course/${s.id}/${i.lesson_id}/${i.id}`),h(!1)},onCourseFinished:()=>o==null?void 0:o(),availableTopicsIds:P})]})]})},os=({program:s})=>{var d;const{topic:n,lesson:t,onNextTopicPreview:o}=G(s,"/courses/preview/"),{t:l}=V();return r.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"})},[n==null?void 0:n.id,t==null?void 0:t.id]),e.jsx(I.Fragment,{children:e.jsx("div",{className:"course-program course-program-page",children:e.jsx("div",{className:"course-program-container",children:e.jsxs("div",{className:"course-program-wrapper course-program-wrapper-preview",children:[e.jsxs("div",{className:"course-program-player",children:[e.jsxs("div",{className:"course-program-player-content",children:[e.jsx("h2",{children:n==null?void 0:n.title}),n&&n.introduction&&e.jsx(E.Col,{sm:12,md:12,lg:12,children:e.jsx("div",{className:"container-md",children:e.jsx(k.MarkdownRenderer,{children:n.introduction})})}),e.jsx("div",{className:"course-program-player-content__wrapper",style:{...((d=n==null?void 0:n.json)==null?void 0:d.wrapperStyle)||{}},children:e.jsx(rs,{preview:!0,topic:n})})]}),e.jsxs(E.Row,{children:[t&&t.summary&&e.jsx(E.Col,{sm:12,md:12,lg:12,children:e.jsx("div",{className:"course-program-summary",children:e.jsx(k.MarkdownRenderer,{children:t.summary})})}),n&&n.summary&&e.jsx(E.Col,{sm:12,md:12,lg:12,children:e.jsx("div",{className:"course-program-summary",children:e.jsx(k.MarkdownRenderer,{children:n.summary})})})]}),e.jsx("div",{className:"course-program-player-next",children:e.jsxs("button",{className:"default-btn default-btn-equal",onClick:()=>o(),children:[e.jsxs("div",{className:"course-program-player-next-button__wrapper",children:[l("Next Topic")," >"]}),e.jsx("span",{})]})})]}),e.jsx(as,{course:s,topicId:Number(n==null?void 0:n.id)})]})})})})},ls=({program:s})=>{var v,m;const n=(m=(v=s==null?void 0:s.scorm)==null?void 0:v.scos)==null?void 0:m.find(j=>j.entry_url!==void 0),t=n==null?void 0:n.uuid,o=r.useRef(null),[l,d]=r.useState(0),w=610,{apiUrl:y}=r.useContext(z.EscolaLMSContext);return r.useEffect(()=>{var j,x,h,f;o.current&&d(((f=(h=(x=(j=o.current)==null?void 0:j.contentWindow)==null?void 0:x.document)==null?void 0:h.body)==null?void 0:f.scrollHeight)||0)},[o]),!n&&!t?e.jsx(I.Fragment,{}):e.jsx(I.Fragment,{children:e.jsx("div",{className:"container-fluid course-program",children:e.jsx("div",{className:"course-program-player scorm",style:{height:`${w+l}px`},children:e.jsx("iframe",{title:"scorm-player",ref:o,src:`${y}/api/scorm/play/${t}`,scrolling:"no"})})})})},ps=()=>{var l,d;const{t:s}=V(),{id:n}=q(),{program:t,fetchProgram:o}=r.useContext(z.EscolaLMSContext);return r.useEffect(()=>{n&&o(Number(n))},[n,o]),t.loading?e.jsx(O,{}):t.error?e.jsx(ss,{children:e.jsxs("div",{className:"alert alert-danger",role:"alert",children:[e.jsx("h4",{className:"alert-heading",children:s("Error")}),e.jsxs("p",{children:[" ",t.error.message||t.error.error]}),e.jsx("hr",{}),e.jsxs("p",{className:"mb-0",children:[s("CoursePage.Preview.SeeOther"),e.jsx(es,{to:ns.courses,children:s("Courses")}),"."]})]})}):t.value&&((d=(l=t==null?void 0:t.value)==null?void 0:l.scorm)!=null&&d.id)?e.jsx(H,{children:e.jsx(ls,{program:t.value})}):t.value&&t.value.lessons&&t.value.lessons.length?e.jsxs(H,{children:[e.jsx(os,{program:t.value}),";"]}):e.jsx(O,{})};export{ps as default};
