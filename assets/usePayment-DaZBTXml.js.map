{"version":3,"file":"usePayment-DaZBTXml.js","sources":["../../src/hooks/usePayment.ts"],"sourcesContent":["import { useContext, useCallback, useState, useMemo } from \"react\";\nimport { EscolaLMSContext } from \"@escolalms/sdk/lib/react/context\";\nimport { useHistory } from \"react-router-dom\";\nimport { useTranslation } from \"react-i18next\";\nimport { InvoiceData } from \"@escolalms/sdk/lib/types\";\nimport { APP_URL } from \"@/config/index\";\nimport { toast } from \"@/utils/toast\";\n\nexport enum PaymentGateway {\n  Stripe = \"Stripe\",\n  Przelewy24 = \"Przelewy24\",\n}\n\nconst usePayment = () => {\n  const {\n    config,\n    user,\n    cart,\n    fetchCart,\n    removeFromCart,\n    payWithStripe,\n    payWithP24,\n    subscriptionPayWithP24,\n    courses,\n    realizeVoucher,\n    resetCart,\n  } = useContext(EscolaLMSContext);\n\n  const { t } = useTranslation();\n  const { push, location } = useHistory();\n  const [processing, setProcessing] = useState(false);\n\n  const [discountStatus, setDiscountStatus] = useState<\n    \"granted\" | \"error\" | undefined\n    //@ts-ignore TODO: add additional_discount type to SDK types\n  >(cart?.value?.additional_discount > 0 ? \"granted\" : undefined);\n\n  const payByStripe = useCallback(\n    async (paymentMethodId: string) => {\n      setProcessing(true);\n      try {\n        if (!user.value?.email) {\n          toast(`${t(\"MissingEmailError\")}`, \"error\");\n          setProcessing(false);\n          return;\n        }\n        await payWithStripe(\n          paymentMethodId,\n          `${APP_URL}/#/cart?status=success`\n        );\n        setProcessing(false);\n\n        push(\"/cart?status=success\");\n        resetCart();\n      } catch (error) {\n        toast(`${t(\"UnexpectedError\")}`, \"error\");\n        setProcessing(false);\n        console.error(error);\n      }\n    },\n    [payWithStripe, push, t, user.value?.email, resetCart]\n  );\n\n  const payByP24 = useCallback(\n    async (values?: InvoiceData) => {\n      setProcessing(true);\n      try {\n        if (!user.value?.email) {\n          toast(`${t(\"MissingEmailError\")}`, \"error\");\n          setProcessing(false);\n          return;\n        }\n        const request = await payWithP24(\n          user.value?.email,\n          `${APP_URL}/#/cart?status=success`,\n          values ? values : undefined\n        ); // @ts-ignore\n        if (request.data.redirect_url === undefined) {\n          toast(`${t(\"UnexpectedError\")}`, \"error\");\n          setProcessing(false);\n          return;\n        }\n\n        setProcessing(false);\n        resetCart();\n        // @ts-ignore\n        window.open(request.data.redirect_url);\n      } catch (error) {\n        toast(`${t(\"UnexpectedError\")}`, \"error\");\n        setProcessing(false);\n        console.error(error);\n      }\n    },\n    [payWithP24, t, user.value?.email, resetCart]\n  );\n\n  const buySubscriptionByP24 = useCallback(\n    async (subId: number) => {\n      setProcessing(true);\n\n      if (!user.value?.email) {\n        toast(`${t(\"MissingEmailError\")}`, \"error\");\n        setProcessing(false);\n        return;\n      }\n      try {\n        const request = await subscriptionPayWithP24(\n          subId,\n          user.value?.email,\n          `${APP_URL}/#/cart?status=success`\n        );\n        // @ts-ignore\n        if (request.data.redirect_url === undefined) {\n          toast(`${t(\"UnexpectedError\")}`, \"error\");\n          setProcessing(false);\n          return;\n        }\n\n        setProcessing(false); // @ts-ignore\n        window.open(request.data.redirect_url);\n        resetCart();\n      } catch (error) {\n        toast(`${t(\"UnexpectedError\")}`, \"error\");\n      }\n    },\n    [t, subscriptionPayWithP24, user.value?.email, resetCart]\n  );\n\n  const defaultGateway = useMemo(() => {\n    return config?.value?.escolalms_payments?.default_gateway ===\n      PaymentGateway.Przelewy24\n      ? PaymentGateway.Przelewy24\n      : PaymentGateway.Stripe;\n  }, [config]);\n\n  return {\n    user,\n    processing,\n    setProcessing,\n    discountStatus,\n    payByStripe,\n    payByP24,\n    removeFromCart,\n    courses,\n    cart,\n    location,\n    push,\n    realizeVoucher,\n    setDiscountStatus,\n    fetchCart,\n    buySubscriptionByP24,\n    defaultGateway,\n  };\n};\n\nexport default usePayment;\n"],"names":["PaymentGateway","usePayment","config","user","cart","fetchCart","removeFromCart","payWithStripe","payWithP24","subscriptionPayWithP24","courses","realizeVoucher","resetCart","useContext","EscolaLMSContext","t","useTranslation","push","location","useHistory","processing","setProcessing","useState","discountStatus","setDiscountStatus","_a","payByStripe","useCallback","paymentMethodId","toast","APP_URL","error","_b","payByP24","values","request","_c","buySubscriptionByP24","subId","_d","defaultGateway","useMemo"],"mappings":"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"}